# .github/workflows/test.yml
name: Run Critical Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # Run only critical tests that must pass for deployment
      - name: Run Critical CSV Tests
        run: npx jest src/__tests__/csvProcessor.test.ts --testNamePattern="Tab-delimited CSV|Comma-delimited CSV|Semicolon-delimited CSV|should detect.*delimiter correctly"

      - name: Run Critical Auth Tests
        run: npx jest src/modules/import/parsers/tests/anz.test.ts

      - name: Run Basic Sum Test
        run: npx jest src/__tests__/sum.tests.ts

      # Build test to ensure deployment will work
      - name: Test Build Process
        run: npm run build
        env:
          VITE_SUPABASE_URL: https://gzznuwtxyyaqlbbrxsuz.supabase.co
          VITE_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd6em51d3R4eXlhcWxiYnJ4c3V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5ODE1NzgsImV4cCI6MjA2NTU1NzU3OH0.u-9MqMTAvSIf2V6qnt8oriNH-Sx-UXU0R6K3gsj5MSw